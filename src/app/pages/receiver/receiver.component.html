<div class="receiver-container">
  <header class="receiver-header">
    <h1>Receptor</h1>
    <p *ngIf="id">Sinal <b><{{ id }}></b></p>
  </header>

  <div *ngIf="loading" class="loading">
    Carregando sinal...
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="!loading && !error && signalData" class="signal-section">
    <h2>Sinal Recebido</h2>
    <div class="chart-wrap">
      <app-signal-chart
        [data]="signalData"
        [title]="'Sinal Modulado Recebido'"
        [type]="'signal'">
      </app-signal-chart>
    </div>

    <!-- Filtro -->
    <details class="nb-section">
      <summary class="nb-heading" (click)="filterOnOff()">
        <b>
          Filtro:
          <span [class.status-on]="filterEnabled" [class.status-off]="!filterEnabled">
            {{ filterEnabled ? 'Ativado' : 'Desligado' }}
          </span>
        </b>
      </summary>
      <form [formGroup]="filterForm" class="form-grid nb-form">
        <div class="signal-row">
          <label>
            f Low (Hz)
            <input type="number" step="10" formControlName="filterLow" />
          </label>
          <label>
            f High (Hz)
            <input type="number" step="10" formControlName="filterHigh" />
          </label>
          <label>
            Ordem FIR (ímpar)
            <input type="number" step="10" formControlName="filterOrder" />
          </label>
        </div>
      </form>

      <span *ngIf="filterEnabled && filterNyquistViolated" class="warn-text">
        Atenção: fHigh ({{ filterHigh | number:'1.0-2' }}) ≥ fs/2 ({{ (fs/2) | number:'1.0-2' }}) — ajuste a banda do filtro.
      </span>

      <!-- Gráfico de Resposta em Frequência do Filtro -->
      <details open class="nb-section" *ngIf="filterEnabled">
        <summary class="nb-heading"><b>Resposta em Frequência do Filtro</b></summary>
        <form [formGroup]="filterForm" class="form-grid nb-form">
          <label>
            Frequência máxima (Hz)
            <input type="number" step="any" formControlName="freqRespMax" />
          </label>
          <div class="info-block">
            <span *ngIf="freqRespMaxExceeded" class="warn-text">
              Atenção: frequência solicitada > fs/2 ({{ (fs/2) | number:'1.0-2' }}). Limitando em fs/2.
            </span>
          </div>
        </form>
        <div class="chart-wrap" *ngIf="freqResponse">
          <app-signal-chart 
            [data]="freqResponse" 
            [type]="'frequency-response'" 
            [xMax]="clampedFreqRespMax"
            title="Resposta em Frequência do Filtro (|H(f)|)">
          </app-signal-chart>
        </div>
      </details>

      <!-- Gráfico do Sinal Filtrado -->
      <details open class="nb-section" *ngIf="filterEnabled">
        <summary class="nb-heading"><b>Sinal Recebido Filtrado</b></summary>
        <div class="chart-wrap" *ngIf="filtered">
          <app-signal-chart 
            [data]="filtered" 
            title="Sinal Filtrado (Passa-Faixa)">
          </app-signal-chart>
        </div>
      </details>
    </details>

    <!-- Demodulação -->
    <form [formGroup]="demodForm" class="demod-form">
      <h3>Configuração da Demodulação</h3>
      <label>
        Tipo:
        <select formControlName="mode">
          <option *ngFor="let m of modulationModes" [value]="m">{{ m }}</option>
        </select>
      </label>
      <label>
        fc (Hz):
        <input type="number" formControlName="fc" />
      </label>
      <label>
        fs (Hz):
        <input type="number" formControlName="fs" />
      </label>
      <label>
        Índice/Constante:
        <input type="number" formControlName="demodConst" step="any" />
      </label>
    </form>

    <div class="chart-wrap" *ngIf="demodulated">
      <app-signal-chart
        [data]="demodulated"
        [title]="'Sinal Demodulado'"
        [type]="'signal'">
      </app-signal-chart>
    </div>
  </div>
</div>
